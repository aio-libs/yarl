trigger:
  branches:
    include:
    - refs/tags/*
pr: none

variables:
- group: codecov

stages:
- stage: lint
  displayName: "Run linters"
  jobs:
  - template: linters-template.yml

- stage: test
  displayName: "Run tests"
  jobs:
  - template: tests-template.yml
    parameters:
      codecov.token: '$(codecov.token)'

- stage: build
  displayName: "Build distributions"
  jobs:
  - job: tarball
    displayName: "Tarball"
    pool:
      vmImage: "ubuntu-latest"

    steps:
      - checkout: self
        clean: true

      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.7'
        displayName: "Use Python 3.7"

      - script: |
          pip install -U setuptools wheel
        displayName: "Install tools"

      - script: |
          python setup.py sdist
        displayName: "Make tarball"

      - task: PublishBuildArtifacts@1
        displayName: "Publish tarball"
        inputs:
          pathtoPublish: 'dist'
          artifactName: tarball

  - job: manylinux
    displayName: "Manylinux"
    pool:
      vmImage: "ubuntu-latest"

    steps:
      - checkout: self
        clean: true

      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.7'
        displayName: "Use Python 3.7"

      - task: DockerInstaller@0
        inputs:
          dockerVersion: '18.03.1-ce'

      - script: |
          pip install -U setuptools wheel
        displayName: "Install tools"

      - script: |
          ./tools/run_docker.sh yaml
        displayName: Build manylinux wheels"

      - task: PublishBuildArtifacts@1
        displayName: "Publish manylinux"
        inputs:
          pathtoPublish: 'dist'
          artifactName: manylinux

  - job: win_36
    displayName: "Win-36"
    pool:
      vmImage: "windows-latest"

    steps:
      - checkout: self
        clean: true

      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.6'
        displayName: "Use Python 3.6"

      - script: |
          pip install -U setuptools wheel
          make cythonize
        displayName: "Install tools"

      - script: |
          python setup.py bdist_wheel
        displayName: "Make wheel"

      - task: PublishBuildArtifacts@1
        displayName: "Publish manylinux"
        inputs:
          pathtoPublish: 'dist'
          artifactName: win-36

  - job: win_37
    displayName: "Win-37"
    pool:
      vmImage: "windows-latest"

    steps:
      - checkout: self
        clean: true

      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.7'
        displayName: "Use Python 3.7"

      - script: |
          pip install -U setuptools wheel
          make cythonize
        displayName: "Install tools"

      - script: |
          python setup.py bdist_wheel
        displayName: "Make wheel"

      - task: PublishBuildArtifacts@1
        displayName: "Publish manylinux"
        inputs:
          pathtoPublish: 'dist'
          artifactName: win-37

- stage: publish
  displayName: "Publish distributions"
  jobs:
  - job:
    pool:
      vmImage: "ubuntu-latest"
    steps:
    - script: |
        mkdir dist

    - task: DownloadBuildArtifacts@0
      displayName: "Download tarball"
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'tarball'
        downloadPath: 'dist'

    - task: DownloadBuildArtifacts@0
      displayName: "Download manylinux"
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'manylinux'
        downloadPath: 'dist'

    - script: |
        tree .
        ls dist
