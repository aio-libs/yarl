trigger:
  branches:
    include:
    - refs/tags/*
pr: none

variables:
- group: codecov

stages:
# - stage: lint
#   displayName: 'Run linters'
#   jobs:
#   - template: linters-template.yml

# - stage: test
#   displayName: 'Run tests'
#   jobs:
#   - template: tests-template.yml
#     parameters:
#       codecov.token: '$(codecov.token)'

- stage: build
  displayName: 'Build distributions'

  jobs:
  - job: tarball
    displayName: 'Tarball'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
      - template: build-wheel.yml
        parameters:
          steps:
            - script: |
                python setup.py sdist
              displayName: 'Make tarball'

  - job: manylinux
    displayName: 'Manylinux'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self
        clean: true

      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.7'
        displayName: 'Use Python 3.7'

      - task: DockerInstaller@0
        inputs:
          dockerVersion: '18.03.1-ce'

      - script: |
          pip install -U setuptools wheel
        displayName: 'Install tools'

      - script: |
          ./tools/run_docker.sh yaml
        displayName: Build manylinux wheels'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish manylinux'
        inputs:
          pathtoPublish: 'dist'
          artifactName: manylinux

  - job:
    strategy:
      matrix:
        win py36 x64:
          python.version: '3.6'
          python.architecture: 'x64'
          image: 'windows-latest'
        win py37 x64:
          python.version: '3.7'
          python.architecture: 'x64'
          image: 'windows-latest'
        win py36 x86:
          python.version: '3.6'
          python.architecture: 'x86'
          image: 'windows-latest'
        win py37 x86:
          python.version: '3.7'
          python.architecture: 'x86'
          image: 'windows-latest'
        mac py36:
          python.version: '3.6'
          image: 'macos-latest'
        mac py37:
          python.version: '3.7'
          image: 'macos-latest'
    pool:
      vmImage: '$(image)'
    steps:
      - template: build-wheel.yml
        parameters:
          python: '$(python.version)'
          architecture: '$(python.architecture)'
          steps:
            - script: |
                make cythonize
                python setup.py bdist_wheel
              displayName: 'Make wheel'
              
- stage: publish
  displayName: 'Publish distributions'
  jobs:
  - job:
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        mkdir dist

    - task: DownloadBuildArtifacts@0
      displayName: 'Download distributions'
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'dist'
        downloadPath: 'dist'

    - script: |
        tree .
        ls dist
